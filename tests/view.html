<!DOCTYPE HTML>
<html>
<head>
    
    <meta charset="UTF-8" />
    <title>QUnit - backstab/view.js</title>
	<link href="http://code.jquery.com/qunit/qunit-1.12.0.css" rel="stylesheet" type="text/css" />
	<link href="../css/style.css" rel="stylesheet" type="text/css" />
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
	<script src="http://documentcloud.github.com/underscore/underscore-min.js" type="text/javascript"></script>
	<script src="http://documentcloud.github.com/backbone/backbone-min.js" type="text/javascript"></script>
	
	<script src="../etc/jquery.tmpl.js" type="text/javascript"></script>
	
	<script src="../backstab/underscore.js" type="text/javascript"></script>
	<script src="../backstab/core.js" type="text/javascript"></script>
	
	<script src="../backstab/foo.js" type="text/javascript"></script>
	<script src="../backstab/view.js" type="text/javascript"></script>
	
</head>

<body>

<p><a href="index.html">Main Menu</a></p>

<div id="qunit"></div>
<div id="qunit-fixture"></div>

<style type="text/css">
	#songlist {
		display: none;
	}
</style>
<ul id="songlist">
	<script id="song-tmpl" type="text/x-jquery-tmpl">  
		<li>
			[ <a href="#" class="del">del</a> | <a href="#" class="edit">edit</a> ] 
			&nbsp;&nbsp;&nbsp; 
			<span class="name"></span> 
			(<span class="artist"></span>) 
			&nbsp;&nbsp;&nbsp;
			<span class="duration"></span>
		</li>
	</script>
</ul>

<script src="http://code.jquery.com/qunit/qunit-1.12.0.js" type="text/javascript"></script>
<script src="funcs.js" type="text/javascript"></script>

<script type="text/javascript">


// song
var Song = Backbone.Model.extend( {
	defaults: {
		name: 'Not specified',
		artist: 'Not specified',
		duration: '0:00'
	}
} );

//// collections

// album
var Album = Backbone.Collection.extend( {
	model: Song
} );


//// views

// list
var ListView = Backstab.View.extend( {
	
	events: {
		'collection:initialize; collection:add': 'addSong',
		'dispatcher:deleteSong': 'deleteSong'
	},
	
	tagName: 'ul',
	
	_items: [],
	
	addSong: function( e, song ) {
		var item = new ItemView( { model: song } );
		this._items.push( item );
		this.$el.append( item.render().$el );
		return item;
	},
	
	deleteSong: function( e, song, item ) {
		this._items = _.without( this._items, item );
		this.collection.remove( song );
	},
	
	render: function() {
		return this;		
	}
	
} );


// item
var ItemView = Backstab.View.extend( {
	
	events: {
		'click .edit': 'editItem',
		'click .del': 'deleteItem',
		'model:change': 'updateSong'
	},
	
	initialize: function() {
		this.$el = $( '#song-tmpl' ).tmpl( {} );
	},
	
	updateSong: function() {
		this._unloadFromModel();			
	},
	
	render: function() {
		this.updateSong();
		return this;
	},
	
	editItem: function() {
		this.dispatcher.trigger( 'editSong', this.model );
		return false;			
	},
	
	deleteItem: function() {
		this.dispatcher.trigger( 'deleteSong', this.model, this );
		this.remove();
		return false;			
	}
	
} );

var sNameTest = 'How Bizarre';

var song1 = new Song( { name: sNameTest, artist: 'OMC', duration: '2:33' } );
var song2 = new Song( { name: 'Sexual Healing', artist: 'Marvin Gaye', duration: '5:40' } );
var song3 = new Song( { name: 'Talk It Over In Bed', artist: 'OMC', duration: '3:19' } );
var song4 = new Song( { name: 'Stillnes Is The Move', artist: 'Dirty Projectors', duration: '5:01' } );

var songs = [ song1, song2, song3, song4 ];

var myAlbum = new Album( songs );
// console.log( myAlbum.models );


//// views

var songlist = new ListView( {
	collection: myAlbum,
	el: $( '#songlist' )
} );

/* ---------------------------------------------------------------------------------------------- */

test( "Backstab.View.extend()", function() {
	
	var eSongList = $( '#songlist' );
	
	var vals1 = { _exp: sNameTest };
	expected(
		eSongList.find( 'span.name' ).eq( 0 ).html(), vals1,
		'First song name should be {{_exp}}'
	);
	
	// change song name
	var sChangeName = 'On the Run';
	song1.set( 'name', sChangeName );
	
	var vals2 = { _exp: sChangeName };
	expected(
		eSongList.find( 'span.name' ).eq( 0 ).html(), vals2,
		'First song name should now be {{_exp}}'
	);
	
	// add new song
	var sNewName = 'Mr. Roboto';
	var oNewSong = new Song( { name: sNewName, artist: 'Styx', duration: '3:10' } );
	myAlbum.add( oNewSong );
	
	var vals3 = { _exp: sNewName };
	expected(
		eSongList.find( 'span.name' ).eq( 4 ).html(), vals3,
		'Fifth song name should be {{_exp}}'
	);
	
} );


</script>

</body>

</html>
